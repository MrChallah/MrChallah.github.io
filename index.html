<!DOCTYPE html><html><head><meta charset="utf-8">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
html,body{margin:0;padding:0;background:transparent;color:#fff;font-family:sans-serif;}
#info{position:absolute;top:8px;left:8px;display:flex;flex-direction:column;gap:4px;}
.row{display:flex;align-items:center;font-size:15px;font-weight:500;text-shadow:0 0 4px #000,0 0 8px #000;}
.row i{width:18px;margin-right:6px;text-align:center;}
</style></head><body>

<div id="info">
  <div class="row"><i class="fa-regular fa-clock"></i><span id="time">--:--:--</span></div>
  <div class="row"><i class="fa-solid fa-location-dot"></i><span id="place">Waiting…</span></div>
  <div class="row"><i class="fa-solid fa-cloud"></i><span id="weather">--°C</span></div>
</div>

<script>
const placeEl = document.getElementById('place');
const weatherEl = document.getElementById('weather');
const OWM_KEY = '618628ae452ff89f0e4477fba20b9d5c';
const GOOGLE_GEO_KEY = 'AIzaSyBFwxZu_EqPgs7pEqk1uHn1f46F6vUoEFU';

let lastKnownLocation = null;
let isIRLPro = false;
let locationAttempts = 0;

// Detect if running in IRL Pro
function detectEnvironment() {
  const userAgent = navigator.userAgent.toLowerCase();
  isIRLPro = userAgent.includes('irlpro') || window.IRLPro || document.title.includes('IRL');
  console.log('Environment:', isIRLPro ? 'IRL Pro' : 'Browser');
}

function tick(){
  const now = new Date();
  const offset = now.getTimezoneOffset() / -60;
  const sign = offset > 0 ? '-' : '+';
  document.getElementById('time').textContent =
    `${now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'})} GMT${sign}${Math.abs(offset)}`;
}
tick(); setInterval(tick, 1000);

async function reverseGeocode(lat, lon){
  const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=en`);
  const geo = await res.json();
  const addr = geo.address;
  const parts = [
    addr.road || addr.suburb || "",
    addr.city || addr.town || addr.village || "",
    addr.state || "",
    addr.country || ""
  ].filter(Boolean);
  return parts.join(", ");
}

async function fetchWeather(lat, lon){
  const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=en&appid=${OWM_KEY}`);
  const j = await r.json();
  const c = j.main.temp.toFixed(0);
  const f = (c * 9 / 5 + 32).toFixed(0);
  const desc = j.weather[0].description.replace(/\b\w/g, s => s.toUpperCase());
  weatherEl.textContent = `${c}°C | ${f}°F, ${desc}`;
}

// Check for IRL Pro injected location data
function checkIRLProLocation() {
  const possibleProps = [
    'locationData', 'gpsData', 'position', 'coordinates', 
    'location', 'gps', 'currentLocation', 'deviceLocation'
  ];
  
  for (const prop of possibleProps) {
    if (window[prop] && typeof window[prop] === 'object') {
      const data = window[prop];
      if (data.latitude && data.longitude) {
        console.log(`Found IRL Pro location in window.${prop}:`, data);
        return { lat: data.latitude, lon: data.longitude, source: `IRL Pro (${prop})` };
      }
    }
  }
  return null;
}

// Get GPS using browser geolocation (for desktop/browser testing)
function getBrowserGPS() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error('Geolocation not supported'));
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (position) => {
        resolve({ 
          lat: position.coords.latitude, 
          lon: position.coords.longitude, 
          accuracy: position.coords.accuracy,
          source: `Browser GPS (±${Math.round(position.coords.accuracy)}m)`
        });
      },
      (error) => {
        console.log('Browser GPS error:', error.message);
        reject(error);
      },
      {
        enableHighAccuracy: true,
        timeout: isIRLPro ? 5000 : 15000, // Shorter timeout in IRL Pro
        maximumAge: isIRLPro ? 60000 : 30000
      }
    );
  });
}

// Fallback Google IP geolocation
async function getGoogleIPLocation(){
  const res = await fetch("https://www.googleapis.com/geolocation/v1/geolocate?key=" + GOOGLE_GEO_KEY, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ considerIp: true })
  });
  const data = await res.json();
  return { lat: data.location.lat, lon: data.location.lng, source: "IP Location" };
}

async function updateLocationAndWeather(){
  try {
    locationAttempts++;
    let locationData = null;
    
    // Strategy 1: Check for IRL Pro injected data
    locationData = checkIRLProLocation();
    
    // Strategy 2: Try browser GPS (mainly for testing)
    if (!locationData && !isIRLPro && locationAttempts <= 2) {
      try {
        placeEl.textContent = "Getting GPS fix...";
        locationData = await getBrowserGPS();
      } catch (e) {
        console.log('Browser GPS failed:', e.message);
      }
    }
    
    // Strategy 3: Fallback to IP location
    if (!locationData) {
      placeEl.textContent = "Using IP location...";
      locationData = await getGoogleIPLocation();
    }
    
    // Update display
    if (locationData) {
      lastKnownLocation = locationData;
      placeEl.textContent = "Loading location...";
      const label = await reverseGeocode(locationData.lat, locationData.lon);
      placeEl.textContent = label;
      fetchWeather(locationData.lat, locationData.lon);
      console.log(`Location: ${locationData.source} - ${locationData.lat}, ${locationData.lon}`);
    }
    
  } catch (e) {
    placeEl.textContent = "Location N/A";
    weatherEl.textContent = "Weather N/A";
    console.error("Location update failed:", e);
  }
}

// Initialize
detectEnvironment();

// Different update strategies for different environments
if (isIRLPro) {
  // In IRL Pro: Check frequently for injected data, then less frequently
  let rapidChecks = 0;
  const rapidChecker = setInterval(() => {
    updateLocationAndWeather();
    rapidChecks++;
    if (rapidChecks >= 10) { // Check rapidly for first 10 attempts
      clearInterval(rapidChecker);
      setInterval(updateLocationAndWeather, 30000); // Then every 30 seconds
    }
  }, 3000); // Every 3 seconds initially
} else {
  // In browser: Normal checking
  setInterval(updateLocationAndWeather, 15000);
}

// Initial load
updateLocationAndWeather();

// For IRL Pro: Listen for potential location events
if (isIRLPro) {
  ['locationupdate', 'gpsupdate', 'positionchange'].forEach(eventName => {
    document.addEventListener(eventName, updateLocationAndWeather);
    window.addEventListener(eventName, updateLocationAndWeather);
  });
}
</script>
</body></html>
