<!DOCTYPE html><html><head><meta charset="utf-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
  html,body{margin:0;padding:0;background:transparent;color:#fff;font-family:sans-serif;}
  #info{position:absolute;top:8px;left:8px;display:flex;flex-direction:column;gap:4px;}
  .row{display:flex;align-items:center;font-size:15px;font-weight:500;text-shadow:0 0 4px #000,0 0 8px #000;}
  .row i{width:18px;margin-right:6px;text-align:center;}
  #gpsButton{
    background:rgba(0,0,0,0.7);
    border:1px solid rgba(255,255,255,0.3);
    color:#fff;
    padding:6px 12px;
    border-radius:4px;
    font-size:12px;
    cursor:pointer;
    margin-top:4px;
    display:none;
  }
  #gpsButton:hover{background:rgba(255,255,255,0.1);}
  .location-clickable{cursor:pointer;color:#4CAF50;}
  .location-clickable:hover{text-decoration:underline;}
  </style></head><body>
  
  <div id="info">
    <div class="row"><i class="fa-regular fa-clock"></i><span id="time">--:--:--</span></div>
    <div class="row">
      <i class="fa-solid fa-location-dot"></i>
      <span id="place" class="location-clickable">Waiting…</span>
    </div>
    <div class="row"><i class="fa-solid fa-cloud"></i><span id="weather">--°C</span></div>
    <button id="gpsButton"><i class="fa-solid fa-satellite-dish"></i> Get GPS</button>
  </div>
  
  <script>
  const placeEl = document.getElementById('place');
  const weatherEl = document.getElementById('weather');
  const gpsButton = document.getElementById('gpsButton');
  const OWM_KEY = '618628ae452ff89f0e4477fba20b9d5c';
  const GOOGLE_GEO_KEY = 'AIzaSyBFwxZu_EqPgs7pEqk1uHn1f46F6vUoEFU';
  
  let lastKnownLocation = null;
  let gpsAttempted = false;
  
  // Detect if we're on mobile
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  
  function tick(){
    const now = new Date();
    const offset = now.getTimezoneOffset() / -60;
    const sign = offset > 0 ? '-' : '+';
    document.getElementById('time').textContent =
      `${now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'})} GMT${sign}${Math.abs(offset)}`;
  }
  tick(); setInterval(tick, 1000);
  
  async function reverseGeocode(lat, lon){
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=en`);
    const geo = await res.json();
    const addr = geo.address;
    const parts = [
      addr.road || addr.suburb || "",
      addr.city || addr.town || addr.village || "",
      addr.state || "",
      addr.country || ""
    ].filter(Boolean);
    return parts.join(", ");
  }
  
  async function fetchWeather(lat, lon){
    const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=en&appid=${OWM_KEY}`);
    const j = await r.json();
    const c = j.main.temp.toFixed(0);
    const f = (c * 9 / 5 + 32).toFixed(0);
    const desc = j.weather[0].description.replace(/\b\w/g, s => s.toUpperCase());
    weatherEl.textContent = `${c}°C | ${f}°F, ${desc}`;
  }
  
  // Method 1: Try IRL Pro location data
  function getIRLProLocation() {
    if (window.locationData && window.locationData.latitude && window.locationData.longitude) {
      return {
        lat: window.locationData.latitude,
        lon: window.locationData.longitude,
        source: "IRL Pro GPS"
      };
    }
    return null;
  }
  
  // Method 2: Try browser GPS
  function getBrowserGPS(userTriggered = false) {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error('Geolocation not supported'));
        return;
      }
      
      // Check if HTTPS is required (most mobile browsers require it)
      if (location.protocol !== 'https:' && location.hostname !== 'localhost' && !location.hostname.includes('127.0.0.1')) {
        console.warn('HTTPS may be required for geolocation on mobile devices');
      }
  
      placeEl.textContent = userTriggered ? "Getting GPS fix..." : "Getting GPS fix...";
      gpsButton.style.display = 'none';
      
      const options = {
        enableHighAccuracy: true,
        timeout: isMobile ? 30000 : 15000, // Longer timeout for mobile
        maximumAge: userTriggered ? 0 : 60000 // Fresh location if user triggered
      };
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          gpsButton.style.display = 'none';
          resolve({
            lat: position.coords.latitude,
            lon: position.coords.longitude,
            accuracy: Math.round(position.coords.accuracy),
            source: `${userTriggered ? 'Manual ' : ''}GPS (±${Math.round(position.coords.accuracy)}m)`
          });
        },
        (error) => {
          console.log('GPS Error:', error.message, 'Code:', error.code);
          
          // Show GPS button on mobile if GPS fails
          if (isMobile && !userTriggered) {
            gpsButton.style.display = 'block';
            placeEl.textContent = "Tap location or GPS button";
            placeEl.className = 'location-clickable';
          }
          
          reject(error);
        },
        options
      );
    });
  }
  
  // Method 3: Fallback to IP location
  async function getLocationFromGoogle(){
    const res = await fetch("https://www.googleapis.com/geolocation/v1/geolocate?key=" + GOOGLE_GEO_KEY, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ considerIp: true })
    });
    const data = await res.json();
    return {
      lat: data.location.lat,
      lon: data.location.lng,
      source: "IP Location"
    };
  }
  
  async function updateLocationAndWeather(userTriggered = false){
    try {
      let locationData = null;
      
      // Try Method 1: IRL Pro location data
      locationData = getIRLProLocation();
      if (locationData) {
        console.log('Using IRL Pro location');
        gpsButton.style.display = 'none';
      }
      
      // Try Method 2: Browser GPS (if no IRL Pro data)
      if (!locationData && (!isMobile || userTriggered || !gpsAttempted)) {
        try {
          locationData = await getBrowserGPS(userTriggered);
          console.log('Using Browser GPS');
          gpsAttempted = true;
        } catch (gpsError) {
          console.log('Browser GPS failed:', gpsError.message);
          gpsAttempted = true;
          
          // On mobile, show the GPS button if GPS fails
          if (isMobile && !userTriggered) {
            gpsButton.style.display = 'block';
          }
        }
      }
      
      // Try Method 3: IP location fallback
      if (!locationData) {
        if (!userTriggered) { // Don't fallback to IP if user specifically requested GPS
          placeEl.textContent = "Using IP location...";
          locationData = await getLocationFromGoogle();
          console.log('Using IP location');
          
          // Show GPS button on mobile to allow manual GPS attempt
          if (isMobile) {
            gpsButton.style.display = 'block';
          }
        } else {
          placeEl.textContent = "GPS unavailable";
          return;
        }
      }
      
      // Update the display
      if (locationData) {
        lastKnownLocation = locationData;
        placeEl.textContent = "Loading location...";
        placeEl.className = '';
        const label = await reverseGeocode(locationData.lat, locationData.lon);
        placeEl.textContent = label;
        fetchWeather(locationData.lat, locationData.lon);
        console.log(`${locationData.source}: ${locationData.lat}, ${locationData.lon}`);
      }
      
    } catch (e) {
      placeEl.textContent = "Location N/A";
      weatherEl.textContent = "Weather N/A";
      console.error("Failed to get location or weather:", e);
      
      // Show GPS button as fallback
      if (isMobile) {
        gpsButton.style.display = 'block';
      }
    }
  }
  
  // Event listeners for user-triggered GPS
  gpsButton.addEventListener('click', () => {
    updateLocationAndWeather(true);
  });
  
  placeEl.addEventListener('click', () => {
    if (placeEl.className.includes('location-clickable')) {
      updateLocationAndWeather(true);
    }
  });
  
  // Request permission on page load for mobile
  if (isMobile && 'permissions' in navigator) {
    navigator.permissions.query({name: 'geolocation'}).then(function(result) {
      console.log('Geolocation permission:', result.state);
      if (result.state === 'denied') {
        gpsButton.style.display = 'block';
        placeEl.textContent = "Location permission denied";
      }
    });
  }
  
  setInterval(() => updateLocationAndWeather(false), 90000);
  updateLocationAndWeather(false);
  </script>
  </body></html>
